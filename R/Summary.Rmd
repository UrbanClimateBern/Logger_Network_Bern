
```{r libraries, include=F}
library(tidyverse)
library(dplyr)
library(lubridate)
```

```{r}
data<-read_csv("../data/Rawdata_T_2023_MJJAS.csv")

data <- data |>
  mutate(Timeshift = Time - dhours(7)) #07 ist das neue 00
```
# Indicators using Nighttime Temperatures (21:00 - 07:00):
Average Tmin per Logger, Tropical Nights, Gfr√∂rli Nights
```{r}
data_night <- data |> 
  filter(hour(Timeshift) >= 14)

data_day <- data |> 
  filter(hour(Timeshift) < 14)

Tmin_night <- data_night |>
  group_by(month=month(Timeshift), day=day(Timeshift)) |>
  summarise_all(~ min(., na.rm = TRUE))

Tmin_night[sapply(Tmin_night, is.infinite)] <- NA

# average tmin per logger
Tmin_night_avg <- Tmin_night |>
  group_by(year = year(Timeshift)) |>
  summarise_all(~ mean(., na.rm = TRUE)) |>
  select(-Time, -Timeshift, -month, -day, -year)

Tropical_nights <- Tmin_night |>
  select(-Time, -month, -day) |>
  group_by(year = year(Timeshift)) |>
  summarise_all(~ sum(. >= 20 & . <= 30, na.rm = TRUE)) |>
  select(-year, -month)

Gfroerli_nights <- Tmin_night |>
  select(-Time, -month, -day) |>
  group_by(year = year(Timeshift)) |>
  summarise_all(~ sum(. <=10 & . >= 0, na.rm = TRUE)) |>
  select(-year, -month)

```




Logs<-colnames(Tmin_night[3:82])
Tropical_Nights_20<-data.frame(Logs,Tmin_avg, TN, GN)


# Indicators using Nighttime Temperatures (22:00 - 06:00)
Mean night temperature, 
```{r}
data_night2 <- data |> 
  filter(hour(Timeshift) >= 15, hour(Timeshift)<23)

# mean night temperature
Tmean_night <- data_night2 |>
  group_by(month=month(Timeshift), day=day(Timeshift)) |>
  summarise_all(~ mean(., na.rm = TRUE))

Tmean_night[sapply(Tmean_night, is.infinite)] <- NA
Tmean_night[sapply(Tmean_night, is.nan)] <- NA

Tmean_night_avg <- Tmean_night |>
  group_by(year = year(Timeshift)) |>
  summarise_all(~ mean(., na.rm = TRUE)) |>
  select(-Time, -Timeshift, -month, -day, -year)

# Urban heat island
# Reference: Zollikofen Referenz 3m
UHI_mean <- Tmean_night |>
  mutate_all(~ .-`Zollikofen 3m`) |>
  select(-month, -day)
UHI_mean[sapply(UHI_mean, is.nan)] <- NA

UHI_mean_avg <- UHI_mean |>
  group_by(year = year(Timeshift)) |>
  summarise_all(~ mean(., na.rm = TRUE)) |>
  select(-Time, -Timeshift, -month, -year) |>
  head(1) #select the first row, since there is a second row with NaN

```


# Indicators using daytime Temperatures (06:00 - 22:00)
Mean daytime temperature
```{r}
data_day <- data |> 
  filter(hour(Timeshift) < 15 | hour(Timeshift) == 23)

# mean day temperature
Tmean_day <- data_day |>
  group_by(month=month(Timeshift), day=day(Timeshift)) |>
  summarise_all(~ mean(., na.rm = TRUE))

Tmean_day[sapply(Tmean_day, is.infinite)] <- NA
Tmean_day[sapply(Tmean_day, is.nan)] <- NA

Tmean_day_avg <- Tmean_day |>
  group_by(year = year(Timeshift)) |>
  summarise_all(~ mean(., na.rm = TRUE)) |>
  select(-Time, -Timeshift, -month, -day, -year)
```

# Indicators using all measurements
```{r}
# Overall mean temperature
Tmean <- data |>
  group_by(month=month(Timeshift), day=day(Timeshift)) |>
  summarise_all(~ mean(., na.rm = TRUE))

Tmean[sapply(Tmean, is.infinite)] <- NA
Tmean[sapply(Tmean, is.nan)] <- NA

Tmean_avg <- Tmean |>
  group_by(year = year(Timeshift)) |>
  summarise_all(~ mean(., na.rm = TRUE)) |>
  select(-Time, -Timeshift, -month, -day, -year)

# Overall max temperature
Tmax <- data |>
  group_by(month=month(Timeshift), day=day(Timeshift)) |>
  summarise_all(~ max(., na.rm = TRUE))

Tmax[sapply(Tmax, is.infinite)] <- NA
Tmax[sapply(Tmax, is.nan)] <- NA

Tmax_avg <- Tmax |>
  group_by(year = year(Timeshift)) |>
  summarise_all(~ mean(., na.rm = TRUE)) |>
  select(-Time, -Timeshift, -month, -day, -year)


# Summer days
Summer_days <- Tmax |>
  select(-Time, -month, -day) |>
  group_by(year = year(Timeshift)) |>
  summarise_all(~ sum(. >= 25 & . <= 50, na.rm = TRUE)) |>
  select(-year, -month)

# Hot days
Hot_days <- Tmax |>
  select(-Time, -month, -day) |>
  group_by(year = year(Timeshift)) |>
  summarise_all(~ sum(. >= 30 & . <= 50, na.rm = TRUE)) |>
  select(-year, -month)

# Very Hot days
VHot_days <- Tmax |>
  select(-Time, -month, -day) |>
  group_by(year = year(Timeshift)) |>
  summarise_all(~ sum(. >= 35 & . <= 50, na.rm = TRUE)) |>
  select(-year, -month)

```
# Final summary table
```{r transpose, include = F}
# Transpose all the indicator tables
Tmean_avg <- as.data.frame(t(head(Tmean_avg))) |> rename(Tmean = V1) |> rownames_to_column(var = "Log_name")
Tmax_avg <- as.data.frame(t(head(Tmax_avg))) |> rename(Tmax = V1) |> rownames_to_column(var = "Log_name")
Tmean_night_avg <- as.data.frame(t(head(Tmean_night_avg))) |> rename(Tmean_night = V1) |> rownames_to_column(var = "Log_name")
Tmin_night_avg <- as.data.frame(t(head(Tmin_night_avg))) |> rename(Tmin_night = V1) |> rownames_to_column(var = "Log_name")
Tmean_day_avg <- as.data.frame(t(head(Tmean_day_avg))) |> rename(Tmean_day = V1) |> rownames_to_column(var = "Log_name")
UHI_mean_avg <- as.data.frame(t(head(UHI_mean_avg))) |> rename(UHI_mean = V1) |> rownames_to_column(var = "Log_name")
Tropical_nights <- as.data.frame(t(head(Tropical_nights))) |> rename(Tropical_nights = V1) |> rownames_to_column(var = "Log_name")
Gfroerli_nights <- as.data.frame(t(head(Gfroerli_nights))) |> rename(Gfroerli_nights = V1) |> rownames_to_column(var = "Log_name")
Summer_days <- as.data.frame(t(head(Summer_days))) |> rename(Summer_days = V1) |> rownames_to_column(var = "Log_name")
Hot_days <- as.data.frame(t(head(Hot_days))) |> rename(Hot_days = V1) |> rownames_to_column(var = "Log_name")
VHot_days <- as.data.frame(t(head(VHot_days))) |> rename(VHot_days = V1) |> rownames_to_column(var = "Log_name")

# Keep in mind this overwrites the original tables, so if you run this chunk again, it transposes back and probably causes an error
```

```{r}
# Join the transposed tables
indicators <- list(Tmean_avg, Tmax_avg, Tmean_night_avg, Tmin_night_avg, Tmean_day_avg, UHI_mean_avg, Tropical_nights, Gfroerli_nights, Summer_days, Hot_days, VHot_days)

Summary <- plyr::join_all(indicators, by = "Log_name", type = "full")
```


Output<-mutate(Output, UHI_all=Tmean_avg_all-20.61285)
Output<-mutate(Output, UHI_night=Tmean_avg_Night-16.68675)
Output<-mutate(Output, UHI_day=Tmean_avg_Day-22.57926)

Output<-select(Output, Logs, Tmean_avg_all, UHI_all, Tmean_avg_Night, UHI_night, Tmean_avg_Day, UHI_day, Tmin_avg, Tmax_avg_all, TN, GN, SD, HD, vHD)

write.table(Output, "Summary_2022_22.csv", sep=";")
