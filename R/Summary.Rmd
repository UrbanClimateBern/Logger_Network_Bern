---
title: "Summary"
author: 'Moritz Burger & Noémie Wellinger'
date: "`r Sys.Date()`"
output: html_document
---

This Rmd script calculates important Urban Climate variables for each logger. These are first calculated for each day of the measure, and finally summarized (averages) in a big summary table.
Note that the time of day over they are calculated differs: whole day (00-24), daytime (6-22) and night (either 22-6 or 21-7).

** NOT SURE HOW EXACTLY WE SHOULD PROCEED FOR THE VALID DAYS. THIS IS NOÉMIE'S SUGGESTION: **
To contextualize the number of hot day for example, we also check the amount of valid days, as in no more than 20% NA. If there are more than 20% NA, all the data of this day is deleted.
** 20% OF COURSE COULD ALSO BE 10%. ALSO, DOES IT MAKE SENSE FOR ALL INDICATORS TO USE THE SAME THRESHOLD? **



```{r libraries, include=F}
library(tidyverse)
library(dplyr)
library(lubridate)
```

```{r read, include = F}
data<-read_csv("../data/Rawdata_T_2023_MJJAS.csv")

# shift the hours, so that the night is not cut in half
data <- data |>
  mutate(Timeshift = Time - dhours(7)) #07 ist das neue 00
```

# Indicators using Nighttime Temperatures (21:00 - 07:00):
Average Tmin per Logger, Tropical Nights, Gfrörli Nights
```{r ind1, include = F}
data_night <- data |> 
  filter(hour(Timeshift) >= 14)

Tmin_night <- data_night |>
  group_by(month=month(Timeshift), day=day(Timeshift)) |>
  summarise_all(~ min(., na.rm = TRUE))

Tmin_night[sapply(Tmin_night, is.infinite)] <- NA

# average tmin per logger
Tmin_night_avg <- Tmin_night |>
  group_by(year = year(Timeshift)) |>
  summarise_all(~ mean(., na.rm = TRUE)) |>
  select(-Time, -Timeshift, -month, -day, -year)

Tropical_nights <- Tmin_night |>
  select(-Time, -month, -day) |>
  group_by(year = year(Timeshift)) |>
  summarise_all(~ sum(. >= 20 & . <= 30, na.rm = TRUE)) |>
  select(-year, -month)

Gfroerli_nights <- Tmin_night |>
  select(-Time, -month, -day) |>
  group_by(year = year(Timeshift)) |>
  summarise_all(~ sum(. <=10 & . >= 0, na.rm = TRUE)) |>
  select(-year, -month)

```




Logs<-colnames(Tmin_night[3:82])
Tropical_Nights_20<-data.frame(Logs,Tmin_avg, TN, GN)


# Indicators using Nighttime Temperatures (22:00 - 06:00)
Mean night temperature, 
```{r}
data_night2 <- data |> 
  filter(hour(Timeshift) >= 15, hour(Timeshift)<23)

# mean night temperature
Tmean_night <- data_night2 |>
  group_by(month=month(Timeshift), day=day(Timeshift)) |>
  summarise_all(~ mean(., na.rm = TRUE))

Tmean_night[sapply(Tmean_night, is.infinite)] <- NA
Tmean_night[sapply(Tmean_night, is.nan)] <- NA

Tmean_night_avg <- Tmean_night |>
  group_by(year = year(Timeshift)) |>
  summarise_all(~ mean(., na.rm = TRUE)) |>
  select(-Time, -Timeshift, -month, -day, -year)

# Urban heat island
# Reference: Zollikofen Referenz 3m
UHI_night <- Tmean_night |>
  mutate_all(~ .-`Zollikofen 3m`) |>
  select(-month, -day)
UHI_night[sapply(UHI_night, is.nan)] <- NA

UHI_night_avg <- UHI_night |>
  group_by(year = year(Timeshift)) |>
  summarise_all(~ mean(., na.rm = TRUE)) |>
  select(-Time, -Timeshift, -month, -year) |>
  head(1) #select the first row, since there is a second row with NaN

```


# Indicators using daytime Temperatures (06:00 - 22:00)
Mean daytime temperature
```{r}
data_day <- data |> 
  filter(hour(Time) >= 6, hour(Time) <= 22) # use time again, to avoid breaking the day apart

# mean day temperature
Tmean_day <- data_day |>
  group_by(month=month(Time), day=day(Time)) |>
  summarise_all(~ mean(., na.rm = TRUE))

Tmean_day[sapply(Tmean_day, is.infinite)] <- NA
Tmean_day[sapply(Tmean_day, is.nan)] <- NA

Tmean_day_avg <- Tmean_day |>
  group_by(year = year(Time)) |>
  summarise_all(~ mean(., na.rm = TRUE)) |>
  select(-Time, -Timeshift, -month, -day, -year)

# Urban heat island
# Reference: Zollikofen Referenz 3m
UHI_day <- Tmean_day |>
  mutate_all(~ .-`Zollikofen 3m`) |>
  select(-month, -day)
UHI_day[sapply(UHI_day, is.nan)] <- NA

UHI_day_avg <- UHI_day |>
  group_by(year = year(Time)) |>
  summarise_all(~ mean(., na.rm = TRUE)) |>
  select(-Time, -Timeshift, -month, -year) |>
  head(1) #select the first row, since there is a second row with NaN
```

# Indicators using measurements of entire day
```{r ind_3, include = F}
# Overall mean temperature
Tmean <- data |>
  group_by(month=month(Time), day=day(Time)) |>
  summarise_all(~ mean(., na.rm = TRUE))

Tmean[sapply(Tmean, is.infinite)] <- NA
Tmean[sapply(Tmean, is.nan)] <- NA

Tmean_avg <- Tmean |>
  group_by(year = year(Timeshift)) |>
  summarise_all(~ mean(., na.rm = TRUE)) |>
  select(-Time, -Timeshift, -month, -day, -year)

# Overall max temperature
Tmax <- data |>
  group_by(month=month(Time), day=day(Time)) |>
  summarise_all(~ max(., na.rm = TRUE))

Tmax[sapply(Tmax, is.infinite)] <- NA
Tmax[sapply(Tmax, is.nan)] <- NA

Tmax_avg <- Tmax |>
  group_by(year = year(Time)) |>
  summarise_all(~ mean(., na.rm = TRUE)) |>
  select(-Time, -Timeshift, -month, -day, -year)

# Urban heat island
# Reference: Zollikofen Referenz 3m
UHI <- Tmean |>
  mutate_all(~ .-`Zollikofen 3m`) |>
  select(-month, -day)
UHI[sapply(UHI, is.nan)] <- NA

UHI_avg <- UHI |>
  group_by(year = year(Time)) |>
  summarise_all(~ mean(., na.rm = TRUE)) |>
  select(-Time, -Timeshift, -month, -year) |>
  head(1) #select the first row, since there is a second row with NaN

# Summer days
Summer_days <- Tmax |>
  select(-Timeshift, -month, -day) |>
  group_by(year = year(Time)) |>
  summarise_all(~ sum(. >= 25 & . <= 50, na.rm = TRUE)) |>
  select(-year, -month)

# Hot days
Hot_days <- Tmax |>
  select(-Timeshift, -month, -day) |>
  group_by(year = year(Time)) |>
  summarise_all(~ sum(. >= 30 & . <= 50, na.rm = TRUE)) |>
  select(-year, -month)

# Very Hot days
VHot_days <- Tmax |>
  select(-Timeshift, -month, -day) |>
  group_by(year = year(Time)) |>
  summarise_all(~ sum(. >= 35 & . <= 50, na.rm = TRUE)) |>
  select(-year, -month)


# TODO
# valid days
# question also valid nights, and daytime ?
# when is a day valid? does it have to be completely without NA or not more than 20% NA or so?
```
# Valid days (DOESN'T WORK YET)
```{r}
# Set threshold for amount of NA data that is allowed
threshold <- 0.2

# Calculate the number of NA values per day
NA_measurements <- data |>
  group_by(date(Time)) |>
  summarize_all(~ sum(is.na(.)))

# Calculate the total number of days and valid days (<= 20% NA)
total_days <- nrow(NA_measurements)
valid_days <- valid_days |>
  summarize_all(~ sum(. <= threshold * 144)) # 144 measurements per day (every 10 mins)

# Calculate the percentage of valid days
percentage_valid_days <- (valid_days / total_days) * 100
```

# Final summary table
```{r transpose, include = F}
# Transpose all the indicator tables
Tmean_avg <- as.data.frame(t(head(Tmean_avg))) |> rename(Tmean = V1) |> rownames_to_column(var = "Log_name")
Tmax_avg <- as.data.frame(t(head(Tmax_avg))) |> rename(Tmax = V1) |> rownames_to_column(var = "Log_name")
Tmean_night_avg <- as.data.frame(t(head(Tmean_night_avg))) |> rename(Tmean_night = V1) |> rownames_to_column(var = "Log_name")
Tmin_night_avg <- as.data.frame(t(head(Tmin_night_avg))) |> rename(Tmin_night = V1) |> rownames_to_column(var = "Log_name")
Tmean_day_avg <- as.data.frame(t(head(Tmean_day_avg))) |> rename(Tmean_day = V1) |> rownames_to_column(var = "Log_name")
UHI_avg <- as.data.frame(t(head(UHI_avg))) |> rename(UHI = V1) |> rownames_to_column(var = "Log_name")
UHI_day_avg <- as.data.frame(t(head(UHI_day_avg))) |> rename(UHI_day = V1) |> rownames_to_column(var = "Log_name")
UHI_night_avg <- as.data.frame(t(head(UHI_night_avg))) |> rename(UHI_night = V1) |> rownames_to_column(var = "Log_name")
Tropical_nights <- as.data.frame(t(head(Tropical_nights))) |> rename(Tropical_nights = V1) |> rownames_to_column(var = "Log_name")
Gfroerli_nights <- as.data.frame(t(head(Gfroerli_nights))) |> rename(Gfroerli_nights = V1) |> rownames_to_column(var = "Log_name")
Summer_days <- as.data.frame(t(head(Summer_days))) |> rename(Summer_days = V1) |> rownames_to_column(var = "Log_name")
Hot_days <- as.data.frame(t(head(Hot_days))) |> rename(Hot_days = V1) |> rownames_to_column(var = "Log_name")
VHot_days <- as.data.frame(t(head(VHot_days))) |> rename(VHot_days = V1) |> rownames_to_column(var = "Log_name")

# Keep in mind this overwrites the original tables, so if you run this chunk again, it transposes back and probably causes an error
```

```{r}
# Join the transposed tables
indicators <- list(Tmean_avg, Tmax_avg, Tmean_night_avg, Tmin_night_avg, Tmean_day_avg, UHI_avg, UHI_day_avg, UHI_night_avg, Tropical_nights, Gfroerli_nights, Summer_days, Hot_days, VHot_days)

Summary <- plyr::join_all(indicators, by = "Log_name", type = "full")
```



```{r export, includ = F}
write_csv(Summary, ("../data/Summary_T_2023_MJJAS.csv"))
```


